<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
        <script src="render.js"></script>       
    </head>
    <body>


        <script>

            function filterOutColumns(data, params) {
                if (!params.dataSource.filterOutColumns.length) return data;
                return data.map(d => {                                        
                    for (const col of params.dataSource.filterOutColumns){
                        delete d[col]
                    }
                    return d;
                })
            }

            function updateParamsFromQueryString(params){
                const urlSearchParams = new URLSearchParams(window.location.search);
                const qs  = Object.fromEntries(urlSearchParams.entries());
                
                if (qs['path'] !== undefined) params.dataSource.path = qs['path'];
                if (qs['name'] !== undefined) params.dataSource.name = qs['name'];
                if (qs['categoryColumn'] !== undefined) params.dataSource.categoryColumn = qs['categoryColumn'];
                if (qs['filterOutColumns'] !== undefined) params.dataSource.filterOutColumns = qs['filterOutColumns'].split(',').map(d => d.trim());
            }
            
            (async function func(){
                
                const res = await fetch('./params.json');
                const params = await res.json();

                updateParamsFromQueryString(params);
                
                const height = params.dims.height - params.margin.top - params.margin.bottom;

                const dataOrig = await d3.csv(params.dataSource.path);                
                let data = filterDataByCols(dataOrig, params.dataSource.filterOutColumns);                
                window.data = data;

                const width = getWidth(params); 
                var svg = d3.select("body")
                    .append("svg")
                        .attr("width", width + params.margin.left + params.margin.right)
                        .attr("height", height + params.margin.top + params.margin.bottom)
                svgG = svg.append("g")
                    .attr("transform", "translate(" + params.margin.left + "," + params.margin.top + ")");

                let classes = Array.from(new Set(data.map(x=>x[params.dataSource.categoryColumn])));

                const paramsOpacity = JSON.parse(JSON.stringify(params));
                paramsOpacity.style.opacity = 1;

                let idCol = Object.keys(dataOrig[0])[0]                
                
                for (const cls of classes) {                    
                    const dataCls = data.filter(d => d[params.dataSource.categoryColumn] == cls);
                    const dataOrigCls = dataOrig.filter(d => d[params.dataSource.categoryColumn] == cls);                    
                    const extentsCls = getExtents(dataCls);
                    //visualize category
                    renderData(svgG, dataCls, params, extentsCls);
                    //return
                    saveSvg(svg.node(), `out--${params.dataSource.name}--classFull--${sanitaizeName(cls)}`);
                    emptySelection(svgG);
                    
                    for (let i = 0; i < dataCls.length; i++) {                        
                        renderData(svgG, [dataCls[i]], paramsOpacity, extentsCls);
                        saveSvg(svg.node(), `out--${params.dataSource.name}--${sanitaizeName(cls)}--${dataOrigCls[i][idCol]}.svg`);
                        emptySelection(svgG);
                        await new Promise(res => setTimeout(res, 100));
                    }

                    // for (let i = 0; i < 50; i++) {                        
                    //     const ixRand = Math.floor(Math.random() * dataCls.length);
                    //     console.log('ixRand', ixRand, dataCls.length)
                    //     renderData(svgG, [dataCls[ixRand]], paramsOpacity, extentsCls);
                    //     saveSvg(svg.node(), `out--${params.dataSource.name}--${sanitaizeName(cls)}--random_${i}_${ixRand}`);
                    //     emptySelection(svgG);
                    //     await new Promise(res => setTimeout(res, 100));
                    // }

                    // const selectedRecords = [];
                    // const remainingRecords = dataCls.slice();

                    // const size = Math.min(params.dataSource.maxObjectsPerCategory, dataCls.length);
                    // for (let i = 0; i < size; i++) {
                    //     const randomIndex = Math.floor(Math.random() * remainingRecords.length);
                    //     selectedRecords.push(remainingRecords[randomIndex]);
                    //     remainingRecords.splice(randomIndex, 1);
                    //     await new Promise(res => setTimeout(res, 100));
                    // }
                    // renderData(svgG, selectedRecords, params, extentsCls);
                    // //saveSvg(svg.node(), `out--${params.path.dataSourceName}--classSubset_${size}--${sanitaizeName(cls)}`);                    
                    // saveSvg(svg.node(), `out--${params.dataSource.name}--classSubset--${sanitaizeName(cls)}`);
                    // emptySelection(svgG); 
                    
                    
                    await new Promise(res => setTimeout(res, 100));
                }
                

                
                // svgG.node().setAttribute("xmlns", "http://www.w3.org/2000/svg");
                // const  svgData = svgG.node().outerHTML;
                // const preface = '<?xml version="1.0" standalone="no"?>\r\n';
                // const svgBlob = new Blob([preface, svgData], {type:"image/svg+xml;charset=utf-8"});
                // const svgUrl = URL.createObjectURL(svgBlob);
                // const downloadLink = document.createElement("a");
                // downloadLink.href = svgUrl;
                // downloadLink.id = "download"                
                // document.body.appendChild(downloadLink);                

            })();

        </script>
        
    </body>
</html>